name: 💻 RDP with LocalXpose

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: 🛠️ Install LocalXpose
      run: choco install localxpose -y

    - name: 🔑 Login to LocalXpose
      run: |
        loclx account login --access-token $env:LOC_TOKEN
      env:
        LOC_TOKEN: ${{ secrets.LOC_TOKEN }}

    - name: 🚀 Start LocalXpose Tunnel (RDP)
      run: |
        Start-Process -FilePath "loclx" -ArgumentList "tunnel tcp --to 3389" `
          -NoNewWindow -RedirectStandardOutput "C:\loclx_out.log" -RedirectStandardError "C:\loclx_err.log"

        Start-Sleep -Seconds 20

        $publicUrl = Get-Content C:\loclx_out.log | Select-String -Pattern "tcp://"
        if (-not $publicUrl) {
          Write-Error "❌ Failed to obtain LocalXpose public address."
          Get-Content C:\loclx_err.log
          exit 1
        }

        Write-Output "✅ RDP available at: $($publicUrl.Matches.Value)"
        Write-Output "🧑 Username: runneradmin"
        Write-Output "🔑 Password: $env:USER_PASS"
      env:
        USER_PASS: ${{ secrets.USER_PASS }}

    - name: 💤 Keep session alive
      run: |
        Write-Output "⏳ Keeping RDP session alive..."
        while ($true) {
          Start-Sleep -Seconds 300
        }
