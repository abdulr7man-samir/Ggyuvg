name: Windows RDP with Telebit

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999
    steps:
    - name: Download Telebit
      run: |
        Invoke-WebRequest -Uri "https://github.com/telebit/telebit-relay/releases/download/v0.20.5/telebit.exe" -OutFile "telebit.exe"
        echo "âœ… Telebit downloaded."

    - name: Start RDP
      run: |
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString "${{ secrets.RDP_PASSWORD }}" -AsPlainText -Force)
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        echo "âœ… RDP enabled."

    - name: Start Telebit Tunnel
      run: |
        Start-Job -Name tbJob -ScriptBlock {
          & .\telebit.exe tcp 3389
        }
        Start-Sleep -Seconds 15
        Get-Job -Name tbJob | Receive-Job -Keep > tunnel.log
        Get-Content tunnel.log

    - name: Show Connection Info
      run: |
        echo "===================================="
        echo "ðŸ”‘ Use this info to connect:"
        echo "IP / Host: (check the telebit tunnel log above â†‘)"
        echo "Username: runneradmin"
        echo "Password: ${{ secrets.RDP_PASSWORD }}"
        echo "===================================="
