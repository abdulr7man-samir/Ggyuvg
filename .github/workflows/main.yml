name: RDP with PageKite

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Download PageKite
      run: |
        Invoke-WebRequest -Uri https://pagekite.net/pk/pagekite.py -OutFile C:\pagekite.py

    - name: Start PageKite tunnel (RDP)
      shell: pwsh
      run: |
        $script = "C:\pagekite.py"
        $sub = "rdpuser.pagekite.me"   # اسم الكايت بتاعك
        $secret = "${{ secrets.PAGEKITE_SECRET }}"
        $out = "C:\pagekite_out.log"
        $err = "C:\pagekite_err.log"

        $formats = @(
          "3389 $($sub):$($secret)",
          "3389 $($sub.Split('.')[0]):$($secret)@pagekite.net",
          "3389 $($sub.Split('.')[0]):$($secret)@pagekite.me",
          "3389 $($sub.Split('.')[0]):$($secret)"
        )

        $success = $false
        foreach ($f in $formats) {
          Write-Host "Trying format: python $script $f"
          $proc = Start-Process -FilePath "python" -ArgumentList "$script $f" -NoNewWindow -PassThru
          Start-Sleep -Seconds 8
          
          if (Get-Process python -ErrorAction SilentlyContinue) {
            Write-Host "PageKite tunnel running with format: $f"
            $success = $true
            break
          }
        }

        if (-not $success) {
          throw "All PageKite formats failed — check PAGEKITE_SECRET and subdomain name"
        }

        # حفظ بيانات الاتصال
        $cred = "C:\rdp_credentials.txt"
        "Host: $sub:3389" | Out-File $cred -Encoding UTF8
        "Username: rdpuser" | Out-File $cred -Append -Encoding UTF8
        "Password: ${{ secrets.RDP_PASSWORD }}" | Out-File $cred -Append -Encoding UTF8
        Write-Host "Saved credentials to $cred"
