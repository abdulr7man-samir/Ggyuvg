- name: 🔑 Login to LocalXpose
  run: |
    loclx account login --access-token $env:LOC_TOKEN
  env:
    LOC_TOKEN: ${{ secrets.LOC_TOKEN }}

- name: 🚀 Start LocalXpose Tunnel (RDP)
  run: |
    # شغل التونيل كـ foreground
    Start-Process -FilePath "loclx" -ArgumentList "tunnel tcp --to 3389" `
      -NoNewWindow -RedirectStandardOutput "C:\loclx_out.log" -RedirectStandardError "C:\loclx_err.log"

    # استنى شوية لحد ما التونيل يفتح
    Start-Sleep -Seconds 20

    # اقرا اللوج واطلع اللينك
    $publicUrl = Get-Content C:\loclx_out.log | Select-String -Pattern "tcp://"
    if (-not $publicUrl) {
      Write-Error "❌ Failed to obtain LocalXpose public address."
      exit 1
    }

    Write-Output "✅ RDP available at: $publicUrl"
    Write-Output "🧑 Username: runneradmin"
    Write-Output "🔑 Password: $env:USER_PASS"
  env:
    USER_PASS: ${{ secrets.USER_PASS }}
