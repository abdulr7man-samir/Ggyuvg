name: RDP via PageKite (auto-try formats)

on:
  workflow_dispatch:

jobs:
  rdp-pagekite:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

      - name: Validate required secrets
        shell: pwsh
        env:
          PAGEKITE_SECRET: ${{ secrets.PAGEKITE_SECRET }}
          RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}
        run: |
          if (-not $env:PAGEKITE_SECRET) { Write-Error "Add secret PAGEKITE_SECRET in repo Settings → Secrets"; exit 1 }
          if (-not $env:RDP_PASSWORD) { Write-Error "Add secret RDP_PASSWORD in repo Settings → Secrets"; exit 1 }
          Write-Host "Secrets present."

      - name: Enable RDP & create user
        shell: pwsh
        env:
          RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}
        run: |
          Write-Host "Enabling Remote Desktop and firewall rule..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0 -Force
          netsh advfirewall firewall add rule name="Allow RDP (pagekite)" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -ErrorAction SilentlyContinue

          $username = "rdpuser"
          $pwd = $env:RDP_PASSWORD
          $secure = ConvertTo-SecureString $pwd -AsPlainText -Force
          if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $username -Password $secure -AccountNeverExpires -PasswordNeverExpires
            Write-Host "User created: $username"
          } else {
            Get-LocalUser -Name $username | Set-LocalUser -Password $secure
            Write-Host "User exists — password updated"
          }
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue

      - name: Download pagekite.py
        shell: pwsh
        run: |
          $out = "C:\pagekite"
          New-Item -Path $out -ItemType Directory -Force | Out-Null
          $dest = Join-Path $out "pagekite.py"
          Write-Host "Downloading pagekite.py ..."
          Invoke-WebRequest -Uri "https://pagekite.net/pk/pagekite.py" -OutFile $dest -UseBasicParsing
          Write-Host "Saved to $dest"
          # show python version available
          Write-Host "Python:"
          python --version 2>$null || Write-Host "python not found on runner (should exist on windows-latest)"

      - name: Start PageKite (try multiple formats) and save credentials
        shell: pwsh
        env:
          PAGEKITE_SECRET: ${{ secrets.PAGEKITE_SECRET }}
          RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}
        run: |
          $script = "C:\pagekite\pagekite.py"
          $sub = "rdpuser.pagekite.me"   # <-- لو غيرت اسم الكايت حط هنا اسمك
          $secret = $env:PAGEKITE_SECRET
          $out = "C:\pagekite\out.log"
          $err = "C:\pagekite\err.log"

          if (-not (Test-Path $script)) {
            Write-Error "pagekite.py not found at $script"
            exit 1
          }

          # صيغ تمرير السر الشائعة — نجرب كل واحدة لحد ما تنجح
          $formats = @(
            "3389 $($sub):$($secret)",
            "3389 $($sub.Split('.')[0]):$($secret)@pagekite.net",
            "3389 $($sub.Split('.')[0]):$($secret)@pagekite.me",
            "3389 $($sub.Split('.')[0]):$($secret)"
          )

          $success = $false
          foreach ($f in $formats) {
            Remove-Item $out -ErrorAction SilentlyContinue
            Remove-Item $err -ErrorAction SilentlyContinue

            Write-Host "Trying format: python $script $f"
            $proc = Start-Process -FilePath "python" -ArgumentList "$script $f" -NoNewWindow -RedirectStandardOutput $out -RedirectStandardError $err -PassThru

            # give it some time to start and print to logs
            Start-Sleep -Seconds 6

            $ok = $false
            $t = 0
            while ($t -lt 40 -and -not $ok) {
              Start-Sleep -Seconds 2
              $t += 2
              if (Test-Path $out) {
                $txt = Get-Content $out -Raw -ErrorAction SilentlyContinue
                if ($txt -match [regex]::Escape($sub) -or $txt -match "listening on|Forwarding|Now serving|http://" -or $txt -match "Connected") {
                  Write-Host "PageKite output indicates success for format: $f"
                  $ok = $true
                  $success = $true
                  break
                }
              }
              if (Test-Path $err) {
                $et = Get-Content $err -Raw -ErrorAction SilentlyContinue
                if ($et -match "error|denied|failed|permission|Not valid domain") {
                  Write-Host "PageKite error detected (will try next format if any):"
                  Write-Host $et
                  break
                }
              }
            }

            if ($ok) {
              # keep the process running (don't kill) — we will output credentials and keep job alive
              Write-Host "Succeeded with format: $f"
              break
            } else {
              try { if (-not $proc.HasExited) { $proc.Kill() } } catch {}
              Write-Host "Format failed, trying next..."
            }
          }

          if (-not $success) {
            Write-Host "===== pagekite OUT (tail 200) ====="
            if (Test-Path $out) { Get-Content $out -Tail 200 } else { Write-Host "(no out log)" }
            Write-Host "===== pagekite ERR (tail 200) ====="
            if (Test-Path $err) { Get-Content $err -Tail 200 } else { Write-Host "(no err log)" }
            throw "All PageKite formats failed — check PAGEKITE_SECRET and subdomain name"
          }

          # Save host/credentials to file (artifact)
          $cred = "C:\rdp_credentials.txt"
          "Host: $sub:3389" | Out-File $cred -Encoding UTF8
          "Username: rdpuser" | Out-File $cred -Append -Encoding UTF8
          "Password: $env:RDP_PASSWORD" | Out-File $cred -Append -Encoding UTF8
          Write-Host "Saved credentials to $cred"
          echo "PAGEKITE_HOST=$sub" >> $env:GITHUB_ENV

      - name: Upload credentials artifact
        uses: actions/upload-artifact@v4
        with:
          name: rdp-credentials
          path: C:\rdp_credentials.txt

      - name: Final output (print final lines) and keep job alive
        shell: pwsh
        env:
          PAGEKITE_HOST: ${{ env.PAGEKITE_HOST }}
          RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}
        run: |
          Write-Host ""
          Write-Host "=== RDP ACCESS ==="
          Write-Host "HOST: $env:PAGEKITE_HOST:3389"
          Write-Host "USERNAME: rdpuser"
          Write-Host "PASSWORD: $env:RDP_PASSWORD"
          Write-Host "==================="
          while ($true) { Start-Sleep -Seconds 300 }
