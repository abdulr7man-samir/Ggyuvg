name: Windows RDP with LocalXpose

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: ğŸ–¥ï¸ Install Chocolatey
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

      - name: ğŸŒ Install LocalXpose
        run: choco install localxpose -y

      - name: ğŸ”‘ Login to LocalXpose
        run: |
          loclx account login --token $env:LOC_TOKEN
        env:
          LOC_TOKEN: ${{ secrets.LOC_TOKEN }}

      - name: ğŸš€ Start LocalXpose Tunnel (RDP)
        run: |
          # Ø´ØºÙ„ Ø§Ù„ØªÙˆÙ†ÙŠÙ„ ÙƒÙ€ foreground
          Start-Process -FilePath "loclx" -ArgumentList "tunnel tcp --to 3389" -NoNewWindow -RedirectStandardOutput loclx.log -RedirectStandardError loclx.log
          
          # Ø§Ø³ØªÙ†Ù‰ Ø´ÙˆÙŠØ© Ù„Ø­Ø¯ Ù…Ø§ Ø§Ù„ØªÙˆÙ†ÙŠÙ„ ÙŠÙØªØ­
          Start-Sleep -Seconds 20
          
          # Ø§Ù‚Ø±Ø§ Ø§Ù„Ù„ÙˆØ¬ ÙˆØ§Ø·Ù„Ø¹ Ø§Ù„Ù„ÙŠÙ†Ùƒ
          $publicUrl = Get-Content loclx.log | Select-String -Pattern "tcp://"
          if (-not $publicUrl) {
            Write-Error "âŒ Failed to obtain LocalXpose public address."
            exit 1
          }

          Write-Output "âœ… RDP available at: $publicUrl"
          Write-Output "ğŸ§‘ Username: runneradmin"
          Write-Output "ğŸ”‘ Password: $env:USER_PASS"
        env:
          USER_PASS: ${{ secrets.USER_PASS }}
