name: Windows RDP with LocalXpose

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: üñ•Ô∏è Install Chocolatey
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

      - name: üåê Install LocalXpose
        run: choco install localxpose -y

      - name: üîë Login to LocalXpose
        run: |
          loclx account login --token $env:LOC_TOKEN
        env:
          LOC_TOKEN: ${{ secrets.LOC_TOKEN }}

      - name: üöÄ Start LocalXpose Tunnel (RDP)
        run: |
          Start-Job -Name loclxJob -ScriptBlock {
            loclx tunnel tcp --to 3389
          }
          Start-Sleep -Seconds 20
          $publicUrl = loclx list tunnels | Select-String -Pattern "tcp://"
          if (-not $publicUrl) {
            Write-Error "‚ùå Failed to obtain LocalXpose public address."
            exit 1
          }
          Write-Output "‚úÖ RDP available at: $publicUrl"
          Write-Output "üßë Username: runneradmin"
          Write-Output "üîë Password: $env:USER_PASS"
        env:
          USER_PASS: ${{ secrets.USER_PASS }}
