name: ğŸ’» RDP with LocalXpose

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: ğŸ› ï¸ Install LocalXpose
      run: choco install localxpose -y

    - name: ğŸ”‘ Login to LocalXpose
      run: |
        loclx account login --access-token $env:LOC_TOKEN
      env:
        LOC_TOKEN: ${{ secrets.LOC_TOKEN }}

    - name: ğŸš€ Start LocalXpose Tunnel (RDP)
      run: |
        Start-Process -FilePath "loclx" -ArgumentList "tunnel tcp --to 3389" `
          -NoNewWindow -RedirectStandardOutput "C:\loclx_out.log" -RedirectStandardError "C:\loclx_err.log"

        Start-Sleep -Seconds 20

        $publicUrl = Get-Content C:\loclx_out.log | Select-String -Pattern "tcp://"
        if (-not $publicUrl) {
          Write-Error "âŒ Failed to obtain LocalXpose public address."
          Get-Content C:\loclx_err.log
          exit 1
        }

        Write-Output "âœ… RDP available at: $($publicUrl.Matches.Value)"
        Write-Output "ğŸ§‘ Username: runneradmin"
        Write-Output "ğŸ”‘ Password: $env:USER_PASS"
      env:
        USER_PASS: ${{ secrets.USER_PASS }}

    - name: ğŸ’¤ Keep session alive
      run: |
        Write-Output "â³ Keeping RDP session alive..."
        while ($true) {
          Start-Sleep -Seconds 300
        }
