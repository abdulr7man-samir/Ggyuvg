name: RDP with PageKite

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Set password
      run: |
        echo "USER_PASS=$env:USER_PASS" >> $env:GITHUB_ENV
      env:
        USER_PASS: ${{ secrets.USER_PASS }}

    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Download PageKite
      run: |
        Invoke-WebRequest -Uri "https://pagekite.net/pk/pagekite.py" -OutFile "C:\pagekite.py"

    - name: Start PageKite tunnel
      run: |
        python C:\pagekite.py 3389 yoursubdomain.pagekite.me:3389
      shell: powershell

    - name: Show RDP Credentials
      run: |
        Write-Output "âœ… Use these credentials to connect:"
        Write-Output "ğŸŒ Host: yoursubdomain.pagekite.me:3389"
        Write-Output "ğŸ§‘ User: runneradmin"
        Write-Output "ğŸ”‘ Password: $env:USER_PASS"
