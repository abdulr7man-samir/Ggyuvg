name: Windows RDP with LocalXpose

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Download LocalXpose
        run: |
          Invoke-WebRequest -Uri "https://github.com/localxpose/cli/releases/latest/download/loclx-windows-amd64.zip" -OutFile "loclx.zip"
          Expand-Archive loclx.zip -DestinationPath .
          move loclx.exe C:\Windows\System32\loclx.exe

      - name: Authenticate LocalXpose
        run: |
          loclx authtoken $env:LOCLX_TOKEN
        env:
          LOCLX_TOKEN: ${{ secrets.LOCLX_TOKEN }}

      - name: Setup RDP user
        run: |
          net user runneradmin MyStrongPass123! /add
          net localgroup administrators runneradmin /add
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f

      - name: Start LocalXpose Tunnel
        run: |
          Start-Process -FilePath "loclx.exe" -ArgumentList "tunnel tcp --to 3389" -NoNewWindow
          Start-Sleep -s 20
          loclx status > tunnel.log
          Get-Content tunnel.log

      - name: Print Credentials
        run: |
          echo "===== RDP DETAILS ====="
          echo "Host: (Check the above loclx status output)"
          echo "Username: runneradmin"
          echo "Password: MyStrongPass123!"
